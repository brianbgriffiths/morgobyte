<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morgobyte - Connect Account</title>
    <link rel="icon" type="image/png" href="/static/images/favicon_64.png">
    <link rel="apple-touch-icon" href="/static/images/favicon_64.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        @font-face {
            font-family: 'TitleFont';
            src: url('/static/fonts/Comfortaa-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'TitleFont', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo img {
            height: 60px;
            margin-bottom: 10px;
        }

        .logo h1 {
            color: #2a2a2a;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-header {
            margin-bottom: 20px;
        }

        .step-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }

        .step-description {
            color: #666;
            line-height: 1.6;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: block;
            text-align: center;
            font-family: 'TitleFont', sans-serif;
        }

        .btn-primary {
            background: #2a2a2a;
            color: #FCC921;
            border: 2px solid #FCC921;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(252, 201, 33, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FCC921;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-icon {
            text-align: center;
            font-size: 64px;
            margin: 20px 0;
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="/static/images/logo1.png" alt="Morgobyte Logo">
            <h1>Morgobyte</h1>
            <p>Offline Audio Card Player</p>
        </div>

        <div id="message" class="message"></div>

        <!-- Step 1: Connect Account -->
        <div id="step-connect" class="step active">
            <div class="step-header">
                <div class="step-title">Account Setup</div>
                <div class="step-description">
                    Authorize this app to access your Yoto library.
                    You'll be redirected to Yoto's login page.
                </div>
                <div class="step-description">
                    Why do we have to do this? Morgobyte needs access to your 
                    Yoto account to download and manage your audio content. 
                    This authorization ensures that only you can access your library, 
                    and we never store your login credentials or data. All tokens, information, 
                    and media are securely stored locally on your device.
                </div>
            </div>
            <button class="btn btn-primary" onclick="startAuthorization()">Connect Yoto Account</button>
        </div>

        <!-- Step 2: Processing -->
        <div id="step-processing" class="step">
            <div class="step-header">
                <div class="step-title">Connecting...</div>
                <div class="spinner"></div>
                <div class="step-description" style="text-align: center;">
                    Exchanging authorization code for access tokens.
                </div>
            </div>
        </div>

        <!-- Step 3: Complete -->
        <div id="step-complete" class="step">
            <div class="success-icon">âœ“</div>
            <div class="step-header">
                <div class="step-title">Setup Complete!</div>
                <div class="step-description" style="text-align: center;">
                    Your Yoto account has been connected successfully.
                </div>
            </div>
            <button class="btn btn-primary" onclick="launchApp()">Launch App</button>
        </div>
    </div>

    <script>
        let db;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('YotoLocalDB', 7);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    console.log('Upgrading database from version', event.oldVersion, 'to', event.newVersion);
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        console.log('Creating settings store');
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains('players')) {
                        console.log('Creating players store');
                        db.createObjectStore('players', { keyPath: 'deviceId' });
                    }
                    if (!db.objectStoreNames.contains('library')) {
                        console.log('Creating library store');
                        db.createObjectStore('library', { keyPath: 'cardId' });
                    }
                    // For images store, delete and recreate to ensure correct keyPath
                    if (db.objectStoreNames.contains('images')) {
                        console.log('Deleting existing images store to recreate with correct keyPath');
                        db.deleteObjectStore('images');
                    }
                    console.log('Creating images store');
                    const imagesStore = db.createObjectStore('images', { keyPath: 'key' });
                    imagesStore.createIndex('cardIdIndex', 'cardId');
                };
            });
        }

        async function saveToIndexedDB(key, value) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                const request = store.put({ key, value });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getFromIndexedDB(key) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => reject(request.error);
            });
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type} show`;
        }

        function goToStep(stepId) {
            console.log('goToStep called with:', stepId);
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            const targetStep = document.getElementById(stepId);
            if (targetStep) {
                targetStep.classList.add('active');
                console.log('Step activated:', stepId);
            } else {
                console.error('Step not found:', stepId);
            }
        }

        async function startAuthorization() {
            // Get server config to check if env credentials are set
            try {
                const configResponse = await fetch('/api/check-config/');
                const config = await configResponse.json();
                
                if (!config.useEnvCredentials) {
                    showMessage('Error: Server must be configured with USE_ENV_CREDENTIALS=true', 'error');
                    return;
                }
            } catch (error) {
                console.error('Failed to check config:', error);
                showMessage('Error: Could not verify server configuration', 'error');
                return;
            }

            // Start OAuth flow - the server will use credentials from .env
            const currentHost = window.location.host;
            const protocol = window.location.protocol;
            const redirectUri = `${protocol}//${currentHost}/callback`;
            
            // We need to get the client ID from the server for the OAuth URL
            // For now, we'll redirect and let the server handle it via a new endpoint
            window.location.href = '/api/start-oauth/';
        }

        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            console.log('handleCallback called, code:', code ? 'present' : 'missing');

            if (!code) {
                return; // Not a callback, stay on connect page
            }

            goToStep('step-processing');

            try {
                const currentHost = window.location.host;
                const protocol = window.location.protocol;
                const redirectUri = `${protocol}//${currentHost}/callback`;

                console.log('Exchanging code for tokens...');
                console.log('redirectUri:', redirectUri);

                // Exchange code for tokens - server will use credentials from .env
                const response = await fetch('/api/auth/token-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code,
                        redirectUri
                    })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok || data.status !== 'success') {
                    throw new Error(data.message || 'Failed to exchange authorization code');
                }
                
                console.log('Saving tokens to IndexedDB...');
                console.log('data.data:', data.data);
                console.log('access_token:', data.data.access_token ? 'present' : 'MISSING');
                console.log('refresh_token:', data.data.refresh_token ? 'present' : 'MISSING');
                console.log('expires_in:', data.data.expires_in);
                
                // Save tokens to IndexedDB for this user
                await saveToIndexedDB('accessToken', data.data.access_token);
                await saveToIndexedDB('refreshToken', data.data.refresh_token);
                await saveToIndexedDB('tokenExpiry', Date.now() + (data.data.expires_in * 1000));

                console.log('Tokens saved to IndexedDB successfully!');
                
                goToStep('step-complete');

                // Clear URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);

            } catch (error) {
                console.error('Token exchange error:', error);
                showMessage('Error during authorization: ' + error.message, 'error');
                goToStep('step-connect');
            }
        }

        function launchApp() {
            window.location.href = '/';
        }

        // Check if already set up
        async function checkExistingSetup() {
            await initDB();
            const refreshToken = await getFromIndexedDB('refreshToken');
            
            console.log('checkExistingSetup: refreshToken =', refreshToken);
            
            // Check if we have a valid refresh token (not just undefined)
            if (refreshToken && refreshToken !== 'undefined') {
                console.log('Already set up with valid refresh token');
                // Already set up
                goToStep('step-complete');
                return true;
            }
            return false;
        }

        // Initialize
        window.addEventListener('load', async () => {
            const alreadySetup = await checkExistingSetup();
            // Only handle callback if not already set up
            if (!alreadySetup) {
                await handleCallback();
            }
        });
    </script>
</body>
</html>
